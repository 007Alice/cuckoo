{"version":3,"sources":["dndupload.js"],"names":["DndUpload","target","endpoint","success_callback","_success_callback","_selectors","generateUUID","_bound","$","empty","html","append","_bind","_self","holder","document","querySelector","filereader","FileReader","dnd","createElement","formdata","window","FormData","progress","XMLHttpRequest","getElementById","split","forEach","api","className","addEventListener","e","event","createEvent","initEvent","dispatchEvent","preventDefault","_process_files","bind","ondragover","ondragend","classList","remove","ondrop","dataTransfer","files","onchange","i","length","_upload","xhr","display_text","open","onload","value","innerHTML","onreadystatechange","readyState","status","setTimeout","upload","onprogress","lengthComputable","complete","loaded","total","send","text","info","Date","getTime"],"mappings":"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","file":"dndupload.js","sourcesContent":["/*\n * Copyright (C) 2010-2013 Claudio Guarnieri.\n * Copyright (C) 2014-2016 Cuckoo Foundation.\n * This file is part of Cuckoo Sandbox - http://www.cuckoosandbox.org\n * See the file 'docs/LICENSE' for copying permission.\n *\n */\n\n/**\n * An abstract HTML widget for file uploads.\n *\n * Supports:\n *   - Multiple files\n *   - Drag & Drop OR file dialog\n *   - Progress bar\n *   - Minimum size on screen: 300x230\n *\n *   Required parameter `target` takes a CSS selector inside which\n *   the necessary HTML is spawned. Multiple of these widgets can exist on\n *   one page due to OOP.\n */\nclass DndUpload {\n    constructor(target, endpoint, success_callback) {\n        this.endpoint = endpoint;\n        this._success_callback = success_callback;\n        this._selectors = {\n            \"uid\": `dndupload_${DndUpload.generateUUID()}`,\n            \"target\": target\n        };\n\n        this._bound = false;\n    }\n\n    /**\n     * Clears `target`, appends HTML and binds events (if necessary)\n     * @return\n     */\n    draw(){\n        $(this._selectors[\"target\"]).empty();\n\n        let html = `\n            <div class=\"dndupload\" id=\"${this._selectors[\"uid\"]}\">\n                <form id=\"uploader\" action=\"/submit/api/presubmit\" method=\"POST\" enctype=\"multipart/form-data\">\n                    <div id=\"container\">\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"43\" viewBox=\"0 0 50 43\">\n                            <path d=\"M48.4 26.5c-.9 0-1.7.7-1.7 1.7v11.6h-43.3v-11.6c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v13.2c0 .9.7 1.7 1.7 1.7h46.7c.9 0 1.7-.7 1.7-1.7v-13.2c0-1-.7-1.7-1.7-1.7zm-24.5 6.1c.3.3.8.5 1.2.5.4 0 .9-.2 1.2-.5l10-11.6c.7-.7.7-1.7 0-2.4s-1.7-.7-2.4 0l-7.1 8.3v-25.3c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v25.3l-7.1-8.3c-.7-.7-1.7-.7-2.4 0s-.7 1.7 0 2.4l10 11.6z\"/>\n                        </svg>\n    \n                        <input type=\"file\" name=\"files[]\" id=\"file\" class=\"holder_input\" data-multiple-caption=\"{count} files selected\" multiple=\"\">\n                        <label for=\"file\" id=\"info\">\n                            <strong>Choose files</strong>\n                            <span class=\"box__dragndrop\"> or drag them here</span>.\n                        </label>\n    \n                        <button type=\"submit\" class=\"holder_button\">Upload</button>\n    \n                        <progress id=\"uploadprogress\" min=\"0\" max=\"100\" value=\"0\">0</progress>\n                    </div>\n                </form>\n            </div>\n\n            <p id=\"filereader\">File API &amp; FileReader API not supported</p>\n            <p id=\"formdata\">XHR2's FormData is not supported</p>\n            <p id=\"progress\">XHR2's upload progress isn't supported</p>\n        `;\n\n        $(this._selectors[\"target\"]).append(html);\n        if(!this._bound) this._bind();\n    }\n\n    /**\n     * Builds references to form elements and creates events.\n     * @return\n     */\n    _bind(){\n        let _self = this;\n        let holder = document.querySelector(`div#${_self._selectors[\"uid\"]}`);\n\n        // save references to the HTML tags that belong exclusively to this widget in\n        // _self._selectors to avoid global namespace pollution.\n        _self._selectors[\"holder\"] = holder;\n        _self._selectors[\"progress\"] = document.querySelector(_self._selectors[\"target\"])\n            .querySelector(\"progress#uploadprogress\");\n        _self._selectors[\"upload\"] = holder.querySelector(\"upload\");\n        _self._selectors[\"form\"] = holder.querySelector(\"form#uploader\");\n\n        // test the current browser capabilities\n        _self._selectors[\"tests\"] = {\n            filereader: typeof FileReader != \"undefined\",\n            dnd: \"draggable\" in document.createElement(\"span\"),\n            formdata: !!window.FormData,\n            progress: \"upload\" in new XMLHttpRequest\n        };\n\n        // keeping track of informative HTML tags\n        _self._selectors[\"support\"] = {\n            filereader: document.getElementById(\"filereader\"),\n            formdata: document.getElementById(\"formdata\"),\n            progress: document.getElementById(\"progress\")\n        };\n\n        \"filereader formdata progress\".split(\" \").forEach(function(api){\n            if (_self._selectors[\"tests\"][api] === false) {\n                _self._selectors[\"support\"][api].className = \"fail\";\n            } else {\n                _self._selectors[\"support\"][api].className = \"hidden\";\n            }\n        });\n\n        // listen for changes on the input tag. If a user choose a file manually; fire the\n        // form submit programmatically\n        _self._selectors[\"holder\"].querySelector('input[type=\"file\"]').addEventListener(\"change\", function(e){\n            var event = document.createEvent(\"HTMLEvents\");\n            event.initEvent(\"submit\", true, false);\n            _self._selectors[\"form\"].dispatchEvent( event );\n        });\n\n        // do our own thing when the form is submitted\n        _self._selectors[\"form\"].addEventListener('submit', function(e){\n            e.preventDefault();\n            this._process_files();\n        }.bind(this));\n\n        // test for drag&drop\n        if (_self._selectors[\"tests\"].dnd){\n            // change appearance while drag&dropping\n            holder.querySelector(\"form#uploader\").ondragover = function(){\n                this.className = \"hover\";\n                return false;\n            };\n\n            holder.querySelector(\"form#uploader\").ondragend = function(){\n                this.className = \"\";\n                return false;\n            };\n\n            [\"dragleave\", \"dragend\", \"drop\"].forEach(function(event){\n                holder.querySelector(\"form#uploader\").addEventListener(event, function(){\n                    //form.classList.remove( \"is-dragover\" );\n                    this.classList.remove(\"hover\");\n                });\n            });\n\n            // process the files on drop\n            holder.querySelector(\"form#uploader\").ondrop = function(e){\n                this.className = \"\";\n                e.preventDefault();\n\n                _self._process_files(e.dataTransfer.files);\n            };\n        } else {\n            this._selectors[\"upload\"].className = \"hidden\";\n            this._selectors[\"upload\"].querySelector(\"input\").onchange = function(){\n                _self._process_files(this.files);\n            };\n        }\n\n        this._bound = true;\n    }\n\n    /**\n     * Reads the files and creates FormData\n     * @return\n     */\n    _process_files(files) {\n        let _self = this;\n        let formdata = new FormData();\n\n        if(_self._selectors[\"holder\"].querySelector('input[type=\"file\"]').files && !files){\n            formdata = new FormData(_self._selectors[\"form\"]);\n        } else {\n            for(var i = 0; i < files.length; i++){\n                formdata.append(\"files[]\", files[i]);\n            }\n        }\n\n        if(formdata){\n            // send the data to the API endpoint\n            this._upload(formdata);\n        }\n    }\n\n    /**\n     * Sends FormData to the endpoint\n     * @return\n     */\n    _upload(formdata){\n        let _self = this;\n        let xhr = new XMLHttpRequest();\n\n        this.display_text(\"Uploading\");\n        formdata[\"type\"] = \"files\";\n\n        xhr.open('POST', this.endpoint);\n\n        // update progress bar when server response is received\n        xhr.onload = function(){\n            _self._selectors[\"progress\"].value = _self._selectors[\"progress\"].innerHTML = 100;\n        };\n\n        xhr.onreadystatechange = function(){\n            if(xhr.readyState === 4){\n                if(xhr.status == 200){\n                    _self.display_text(\"Done\");\n\n                    setTimeout(function() {\n                        _self._success_callback(xhr)\n                    }, 600);\n                } else if(xhr.status == 0) {\n\n                } else {\n                    _self.display_text(`Error: http.status = ${xhr.status} OR response.status not OK`);\n                }\n            }\n        };\n\n        // update progress bar while uploading\n        if(this._selectors[\"tests\"].progress){\n            xhr.upload.onprogress = function(event){\n                if(event.lengthComputable){\n                    let complete = (event.loaded / event.total*100 | 0);\n                    _self._selectors[\"progress\"].value = _self._selectors[\"progress\"].innerHTML = complete;\n                }\n            }\n        }\n\n        xhr.send(formdata);\n    }\n\n    /**\n     * Changes the text displayed to the user\n     * @return\n     */\n    display_text(text){\n        let info = $(this._selectors[\"form\"].querySelector(\"label#info\"));\n        info.html(text);\n    }\n\n    /**\n     * Generates UUID\n     * @return\n     */\n    static generateUUID(){\n        return (new Date).getTime();\n    }\n}"]}